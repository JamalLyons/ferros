# Justfile for Ferros development
# Run `just setup` to get started

# Default recipe - show available commands
default:
    @just --list

# Setup development environment for new contributors
setup: check-prerequisites install-rust install-nightly verify-setup run-setup-tests
    @echo ""
    @echo "ðŸŽ‰ Setup complete! You're ready to contribute to Ferros."
    @echo ""
    @echo "Next steps:"
    @echo "  â€¢ Run 'just fmt' to format code"
    @echo "  â€¢ Run 'just lint' to check code quality"
    @echo "  â€¢ Run 'just test' to run tests"
    @echo "  â€¢ Read CONTRIBUTING.md for guidelines"

# Run tests as part of setup
run-setup-tests:
    @echo ""
    @echo "ðŸ§ª Running tests..."
    @cargo test --workspace --all-features

# Check if prerequisites are installed
check-prerequisites:
    @echo "ðŸ¦€ Setting up Ferros development environment..."
    @echo ""
    @echo "ðŸ“‹ Checking prerequisites..."
    @command -v git >/dev/null 2>&1 || { echo "âŒ git is not installed. Please install git first."; exit 1; }
    @echo "  âœ“ git found"
    @command -v rustup >/dev/null 2>&1 || { echo "  âš  rustup not found - will install"; exit 0; }
    @echo "  âœ“ rustup found"
    @command -v cargo >/dev/null 2>&1 || { echo "  âš  cargo not found - will install with rustup"; exit 0; }
    @echo "  âœ“ cargo found"
    @command -v cargo-ws >/dev/null 2>&1 || { echo "  âš  cargo-ws not found (optional, install with: cargo install cargo-workspaces)"; exit 0; }
    @echo "  âœ“ cargo-ws found"

# Install Rust toolchain via rustup
install-rust:
    @echo ""
    @echo "ðŸ”§ Installing Rust toolchain..."
    @if ! command -v rustup >/dev/null 2>&1; then \
        echo "Installing rustup..."; \
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y; \
        export PATH="$HOME/.cargo/bin:$PATH"; \
        echo "  âœ“ rustup installed"; \
    else \
        echo "  âœ“ rustup already installed"; \
    fi
    @if ! command -v cargo >/dev/null 2>&1; then \
        echo "  âš  cargo not in PATH. Please run: source $HOME/.cargo/env"; \
    fi

# Install nightly toolchain with rustfmt component
install-nightly:
    @echo ""
    @echo "ðŸŒ™ Installing nightly toolchain with rustfmt..."
    @rustup toolchain install nightly --component rustfmt 2>&1 | grep -v "info:" || true
    @echo "  âœ“ nightly toolchain installed"
    @rustup toolchain list | grep -q nightly || { echo "  âš  Failed to install nightly"; exit 1; }

# Verify that everything is set up correctly
verify-setup:
    @echo ""
    @echo "âœ… Verifying setup..."
    @echo "Verifying Rust installation..."
    @rustc --version || { echo "  âŒ rustc not found"; exit 1; }
    @echo "  âœ“ rustc: $(rustc --version | cut -d' ' -f2)"
    
    @echo "Verifying cargo..."
    @cargo --version || { echo "  âŒ cargo not found"; exit 1; }
    @echo "  âœ“ cargo: $(cargo --version | cut -d' ' -f2)"
    
    @echo "Verifying nightly toolchain..."
    @rustup toolchain list | grep -q nightly || { echo "  âŒ nightly toolchain not found"; exit 1; }
    @echo "  âœ“ nightly toolchain installed"
    
    @echo "Verifying rustfmt..."
    @cargo fmt --version >/dev/null 2>&1 || { echo "  âŒ rustfmt not found"; exit 1; }
    @echo "  âœ“ rustfmt: $(cargo fmt --version | cut -d' ' -f2)"
    
    @echo "Verifying clippy..."
    @cargo clippy --version >/dev/null 2>&1 || { echo "  âš  clippy not found (optional)"; exit 0; }
    @echo "  âœ“ clippy: $(cargo clippy --version | cut -d' ' -f2)"
    
    @echo "Verifying cargo-workspaces..."
    @cargo ws --version >/dev/null 2>&1 || { echo "  âš  cargo-ws not found (optional)"; exit 0; }
    @echo "  âœ“ cargo-ws: $(cargo ws --version | cut -d' ' -f2)"

# Format all code
fmt:
    @echo "ðŸŽ¨ Formatting code..."
    @cargo fmt --all

# Check formatting without making changes
fmt-check:
    @echo "ðŸ” Checking code formatting..."
    @cargo fmt --all -- --check

# Run clippy linter
lint:
    @echo "ðŸ” Running clippy..."
    @cargo clippy --all --all-targets -- -D warnings

# Run clippy with auto-fix
lint-fix:
    @echo "ðŸ”§ Running clippy with auto-fix..."
    @cargo clippy --all --all-targets --fix --allow-dirty --allow-staged

# Run all tests
test:
    @echo "ðŸ§ª Running tests..."
    @cargo test --workspace --all-features

# Run tests for a specific crate (usage: just test-crate ferros-core)
test-crate CRATE:
    @echo "ðŸ§ª Running tests for {{CRATE}}..."
    @cargo test -p {{CRATE}} --all-features

# Build the project
build:
    @echo "ðŸ”¨ Building project..."
    @cargo build --workspace --all-features

# Build in release mode
build-release:
    @echo "ðŸ”¨ Building release..."
    @cargo build --release --workspace --all-features

# Build and open documentation
docs:
    @echo "ðŸ“š Building and opening documentation..."
    @cargo doc --workspace --open --no-deps

# Build documentation without opening
docs-build:
    @echo "ðŸ“š Building documentation..."
    @cargo doc --workspace --no-deps

# Run all checks (fmt, clippy, test)
check:
    @echo "ðŸ” Running all checks..."
    @just fmt
    @just lint
    @just test

# Clean build artifacts
clean:
    @echo "ðŸ§¹ Cleaning build artifacts..."
    @cargo clean

# Show project information
info:
    @echo "ðŸ¦€ Ferros Development Information"
    @echo ""
    @echo "Rust version: $(rustc --version)"
    @echo "Cargo version: $(cargo --version)"
    @echo "Toolchain: $(rustup show active-toolchain 2>/dev/null || echo 'unknown')"
    @echo ""
    @echo "Workspace crates:"
    @cargo ws list

# List workspace crates using cargo-ws
list:
    @echo "ðŸ“¦ Workspace crates:"
    @cargo ws list 2>/dev/null || { \
        echo "  âš  cargo-ws failed. This may be due to workspace configuration issues."; \
        echo "  Try running 'just clean' to remove build artifacts."; \
        exit 1; \
    }

# List crates that have changed since last tagged release
changed:
    @echo "ðŸ“ Changed crates since last release:"
    @cargo ws changed

# Execute a command in each crate (usage: just exec "cargo test")
exec COMMAND:
    @echo "ðŸ”§ Executing '{{COMMAND}}' in each crate..."
    @cargo ws exec {{COMMAND}}

# Bump version of crates (usage: just version patch|minor|major)
version LEVEL:
    @echo "ðŸ“Œ Bumping {{LEVEL}} version across workspace..."
    @cargo ws version {{LEVEL}}

# Show publishing plan
plan:
    @echo "ðŸ“‹ Publishing order:"
    @cargo ws plan 2>&1 | grep -v "^error: config value" || true

# Publish all crates in the workspace (with version bumping)
# Usage: just publish [BUMP]
# Examples:
#   just publish              # Interactive version bump and publish
#   just publish patch        # Bump patch version and publish
#   just publish minor        # Bump minor version and publish
#   just publish major        # Bump major version and publish
# Note: For additional options (--yes, --allow-dirty, etc.), use cargo ws publish directly
publish BUMP="":
    @echo "ðŸ“¦ Publishing workspace crates..."
    @if [ -z "{{BUMP}}" ]; then \
        cargo ws publish; \
    else \
        cargo ws publish {{BUMP}}; \
    fi

# Publish crates without versioning (from current git state)
publish-as-is:
    @echo "ðŸ“¦ Publishing workspace crates as-is (no version bump)..."
    @cargo ws publish --publish-as-is

# Publish with a delay between crates to avoid rate limiting
# Usage: just publish-with-delay [BUMP] [SECONDS]
# Example: just publish-with-delay patch 10
publish-with-delay BUMP="patch" SECONDS="10":
    @echo "ðŸ“¦ Publishing workspace crates with {{SECONDS}}s delay between publishes..."
    @cargo ws publish {{BUMP}} --publish-interval {{SECONDS}}
